<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>binngo MAKER - Jogador</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #8bc34a, #ffeb3b, #ff9800, #e91e63);
            background-size: 400% 400%;
            animation: gradientAnimation 15s ease infinite;
            color: #fff;
            text-align: center;
            padding-bottom: 50px;
        }

        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .header {
            width: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 15px 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
        }

        .header h1 {
            font-family: 'Press Start 2P', cursive;
            color: #ffeb3b;
            font-size: 2em;
            margin: 0;
            text-shadow: 3px 3px #e91e63;
            letter-spacing: 1px;
        }

        .container {
            background-color: rgba(0, 0, 0, 0.8);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            max-width: 800px;
            width: 90%;
            margin-top: 20px;
            animation: fadeIn 1s ease-out;
            text-align: left;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h2 {
            color: #ffeb3b;
            font-size: 1.8em;
            margin-bottom: 20px;
            text-align: center;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #fff;
        }

        input[type="text"],
        input[type="password"] {
            width: calc(100% - 20px);
            padding: 12px;
            margin-bottom: 20px;
            border: none;
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.9);
            color: #333;
            font-size: 1em;
        }

        .button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 25px;
            font-size: 1.1em;
            font-weight: bold;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background-color: #4CAF50; /* Verde */
            box-shadow: 0 5px #388E3C;
        }
        .btn-primary:hover { background-color: #66BB6A; transform: translateY(-2px); box-shadow: 0 7px #388E3C; }

        .btn-danger {
            background-color: #F44336; /* Vermelho */
            box-shadow: 0 5px #D32F2F;
        }
        .btn-danger:hover { background-color: #EF5350; transform: translateY(-2px); box-shadow: 0 7px #D32F2F; }

        .btn-warning {
            background-color: #FFC107; /* Amarelo */
            color: #333;
            box-shadow: 0 5px #FFA000;
        }
        .btn-warning:hover { background-color: #FFD54F; transform: translateY(-2px); box-shadow: 0 7px #FFA000; }

        .screen {
            display: none; /* Esconde todas as telas por padrÃ£o */
        }

        #player-waiting-screen ul {
            list-style: none;
            padding: 0;
            margin-top: 20px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
        }

        #player-waiting-screen ul li {
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        #player-game-screen .game-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        #player-game-screen .game-info p {
            margin: 0;
            font-size: 1.1em;
        }

        #player-game-screen .last-drawn-ball-player {
            font-size: 3em;
            font-weight: bold;
            color: #ffeb3b;
            text-shadow: 3px 3px #e91e63;
            margin: 10px auto;
            display: block;
            text-align: center;
        }

        #player-game-screen .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .bingo-card {
            background-color: #fefefe;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            color: #333;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .bingo-card h3 {
            margin-top: 0;
            color: #e91e63;
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .bingo-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
            margin-top: 10px;
        }

        .bingo-cell {
            width: 100%;
            padding-top: 100%; /* Makes cells square */
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #eee;
            border-radius: 5px;
            font-weight: bold;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .bingo-cell span {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .bingo-cell.header-cell {
            background-color: #ffeb3b;
            color: #333;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.9em;
        }

        .bingo-cell.free-space {
            background-color: #ff9800;
            color: #fff;
        }

        .bingo-cell.marked {
            background-color: #8bc34a;
            color: #fff;
        }

        .bingo-card.bingo-winner {
            border: 5px solid #ffeb3b;
            box-shadow: 0 0 20px #ffeb3b;
            animation: pulse 1.5s infinite alternate;
        }

        @keyframes pulse {
            from { transform: scale(1); box-shadow: 0 0 20px #ffeb3b; }
            to { transform: scale(1.02); box-shadow: 0 0 30px #ffeb3b, 0 0 40px #ffeb3b; }
        }

        .bingo-card .bingo-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(233, 30, 99, 0.8); /* Rosa */
            color: #fff;
            font-family: 'Press Start 2P', cursive;
            font-size: 3em;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 10px;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .bingo-card.bingo-winner .bingo-overlay {
            opacity: 1;
        }

        .drawn-balls-history-player {
            margin-top: 20px;
            background-color: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 10px;
            max-height: 100px;
            overflow-y: auto;
            text-align: center;
        }

        .drawn-balls-history-player span {
            display: inline-block;
            background-color: #2196F3;
            color: #fff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            line-height: 30px;
            margin: 3px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border-radius: 10px;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            text-align: center;
            color: #333;
            position: relative;
        }

        .modal-content h3 {
            color: #e91e63;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .modal-content p {
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .modal-content .button-group {
            margin-top: 25px;
        }

        .close-button {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-button:hover,
        .close-button:focus {
            color: #333;
            text-decoration: none;
            cursor: pointer;
        }

        .footer {
            margin-top: 40px;
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.7);
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5em;
            }
            h2 {
                font-size: 1.4em;
            }
            .container {
                padding: 20px;
            }
            .btn {
                padding: 10px 20px;
                font-size: 1em;
            }
            .bingo-card h3 {
                font-size: 1em;
            }
            .bingo-cell {
                font-size: 1em;
            }
            .bingo-cell.header-cell {
                font-size: 0.8em;
            }
            .bingo-card .bingo-overlay {
                font-size: 2em;
            }
            .modal-content {
                width: 95%;
                padding: 20px;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.2em;
            }
            h2 {
                font-size: 1.2em;
            }
            .container {
                padding: 15px;
            }
            .btn {
                font-size: 0.9em;
                padding: 8px 15px;
            }
            .bingo-card h3 {
                font-size: 0.9em;
            }
            .bingo-cell {
                font-size: 0.9em;
            }
            .bingo-cell.header-cell {
                font-size: 0.7em;
            }
            .bingo-card .bingo-overlay {
                font-size: 1.5em;
            }
            .modal-content h3 {
                font-size: 1.2em;
            }
            .modal-content p {
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>binngo MAKER</h1>
    </div>

    <div class="container">
        <!-- Screen 1: Cadastro do Jogador -->
        <div id="player-registration-screen" class="screen">
            <h2>Bem-vindo ao Bingo!</h2>
            <p>VocÃª estÃ¡ entrando na sala: <strong id="registration-room-name"></strong></p>
            <label for="player-name">Seu Nome:</label>
            <input type="text" id="player-name" placeholder="Nome" required>
            <label for="player-surname">Seu Sobrenome:</label>
            <input type="text" id="player-surname" placeholder="Sobrenome" required>
            <div id="password-input-group" style="display: none;">
                <label for="player-password">Senha da Cartela (opcional):</label>
                <input type="password" id="player-password" placeholder="Senha">
            </div>
            <div class="button-group">
                <button class="btn btn-primary" onclick="registerPlayer()">Entrar na Sala</button>
            </div>
        </div>

        <!-- Screen 2: Espera do Jogo -->
        <div id="player-waiting-screen" class="screen">
            <h2>Aguarde o inÃ­cio do jogo...</h2>
            <p>VocÃª estÃ¡ na sala: <strong id="waiting-room-name-player"></strong></p>
            <p>OlÃ¡, <strong id="waiting-player-name"></strong>!</p>
            <h3>Regras da Partida:</h3>
            <ul id="game-rules-list">
                <!-- Regras serÃ£o carregadas aqui -->
            </ul>
        </div>

        <!-- Screen 3: Tela de Jogo -->
        <div id="player-game-screen" class="screen">
            <h2>Hora do Bingo!</h2>
            <div class="game-info">
                <p>Sala: <strong id="game-room-name"></strong></p>
                <p>Jogador: <strong id="game-player-name"></strong></p>
                <p>Ãšltima Bola: <span class="last-drawn-ball-player" id="last-drawn-ball-player">--</span></p>
            </div>

            <div class="button-group">
                <button class="btn btn-warning" id="call-bingo-btn" onclick="callBingo()">CHAMAR BINGO!</button>
            </div>

            <h3>Suas Cartelas:</h3>
            <div class="cards-container" id="player-cards-container">
                <!-- Cartelas serÃ£o geradas aqui -->
            </div>

            <h3>HistÃ³rico de Bolas:</h3>
            <div class="drawn-balls-history-player" id="drawn-balls-history-player">
                <!-- Bolas sorteadas aparecerÃ£o aqui -->
            </div>
        </div>
    </div>

    <!-- Modal de ConfirmaÃ§Ã£o de BINGO -->
    <div id="player-bingo-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('player-bingo-modal')">&times;</span>
            <h3>VocÃª chamou BINGO!</h3>
            <p>Aguarde o administrador validar sua cartela.</p>
            <p>Tipo de BINGO: <strong id="player-bingo-type"></strong> na cartela <strong id="player-bingo-card-id"></strong></p>
            <div class="button-group">
                <button class="btn btn-primary" onclick="closeModal('player-bingo-modal')">OK</button>
            </div>
        </div>
    </div>

    <!-- Modal de Vencedor -->
    <div id="winner-notification-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('winner-notification-modal')">&times;</span>
            <h3>ðŸŽ‰ VENCEDOR! ðŸŽ‰</h3>
            <p><strong id="winner-name"></strong> venceu o BINGO com <strong id="winner-bingo-type"></strong>!</p>
            <p id="winner-message"></p>
            <div class="button-group">
                <button class="btn btn-primary" onclick="closeModal('winner-notification-modal')">Entendi</button>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>&copy; 2023 binngo MAKER. Todos os direitos reservados.</p>
    </div>

    <script>
        const GAME_STATE_KEY = 'bingoGameState';
        const PLAYER_STATE_KEY = 'bingoPlayerState';
        let gameState = {};
        let playerState = {};
        let currentScreen = '';
        let roomIdFromUrl = '';

        const screens = {
            registration: document.getElementById('player-registration-screen'),
            waiting: document.getElementById('player-waiting-screen'),
            game: document.getElementById('player-game-screen')
        };

        function showScreen(screenId) {
            Object.values(screens).forEach(screen => screen.style.display = 'none');
            if (screens[screenId]) {
                screens[screenId].style.display = 'block';
                currentScreen = screenId;
            }
        }

        function loadPlayerState() {
            const storedPlayerState = sessionStorage.getItem(PLAYER_STATE_KEY);
            if (storedPlayerState) {
                playerState = JSON.parse(storedPlayerState);
            } else {
                playerState = {
                    id: generatePlayerId(),
                    name: '',
                    surname: '',
                    roomId: '',
                    cards: [],
                    status: 'unregistered' // unregistered, registered, bingo_called, winner, eliminated
                };
            }
        }

        function savePlayerState() {
            sessionStorage.setItem(PLAYER_STATE_KEY, JSON.stringify(playerState));
        }

        function generatePlayerId() {
            return 'player_' + Math.random().toString(36).substring(2, 11);
        }

        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\[').replace(/[\]]/, '\]');
            var regex = new RegExp('[\?&]' + name + '=([^&#]*)');
            var results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        function updatePlayerUI() {
            // Check if room exists and player is part of it
            if (!gameState.roomId || gameState.roomId !== playerState.roomId) {
                // If player is registered for a different room or room doesn't exist, reset
                if (playerState.status !== 'unregistered') {
                    alert('A sala de bingo foi encerrada ou vocÃª foi desconectado.');
                    sessionStorage.removeItem(PLAYER_STATE_KEY);
                    window.location.href = 'index.html'; // Redirect to home
                    return;
                }
            }

            // Update common elements
            document.getElementById('registration-room-name').textContent = gameState.roomName || 'N/A';
            document.getElementById('waiting-room-name-player').textContent = gameState.roomName || 'N/A';
            document.getElementById('waiting-player-name').textContent = playerState.name || 'Jogador';
            document.getElementById('game-room-name').textContent = gameState.roomName || 'N/A';
            document.getElementById('game-player-name').textContent = playerState.name || 'Jogador';
            document.getElementById('last-drawn-ball-player').textContent = gameState.lastDrawnBall || '--';

            // Update drawn balls history
            const drawnBallsHistoryDiv = document.getElementById('drawn-balls-history-player');
            drawnBallsHistoryDiv.innerHTML = gameState.drawnBalls.map(ball => `<span>${ball}</span>`).join('');
            drawnBallsHistoryDiv.scrollTop = drawnBallsHistoryDiv.scrollHeight;

            // Show appropriate screen based on player and game state
            if (playerState.status === 'unregistered') {
                showScreen('registration');
                document.getElementById('password-input-group').style.display = gameState.adminSettings.passwordEnabled ? 'block' : 'none';
            } else if (gameState.gamePhase === 'waiting' || gameState.gamePhase === 'config' || gameState.gamePhase === 'setup') {
                showScreen('waiting');
                const rulesList = document.getElementById('game-rules-list');
                rulesList.innerHTML = gameState.rules.map(rule => `<li>${rule}</li>`).join('');
            } else if (gameState.gamePhase === 'playing' || gameState.gamePhase === 'bingo_called' || gameState.gamePhase === 'tie_breaker') {
                showScreen('game');
                renderPlayerCards();
                if (playerState.status === 'eliminated') {
                    document.getElementById('call-bingo-btn').disabled = true;
                    document.getElementById('call-bingo-btn').textContent = 'ELIMINADO';
                } else {
                    document.getElementById('call-bingo-btn').disabled = false;
                    document.getElementById('call-bingo-btn').textContent = 'CHAMAR BINGO!';
                }
            } else if (gameState.gamePhase === 'ended') {
                alert('O bingo foi encerrado pelo administrador.');
                sessionStorage.removeItem(PLAYER_STATE_KEY);
                window.location.href = 'index.html';
            }

            // Handle winner notification
            if (gameState.winner && gameState.winner.playerId !== playerState.id && playerState.status !== 'winner') {
                document.getElementById('winner-name').textContent = gameState.winner.name;
                document.getElementById('winner-bingo-type').textContent = gameState.winner.bingoType;
                document.getElementById('winner-message').textContent = gameState.adminSettings.winnerContinues ? 'O jogo continua para os outros prÃªmios!' : 'O jogo continua para os outros prÃªmios, mas o vencedor nÃ£o participa mais.';
                openModal('winner-notification-modal');
                gameState.winner = null; // Clear winner after showing to player
                saveGameState();
            }
        }

        function registerPlayer() {
            const name = document.getElementById('player-name').value.trim();
            const surname = document.getElementById('player-surname').value.trim();
            const password = document.getElementById('player-password').value.trim();

            if (!name || !surname) {
                alert('Por favor, preencha seu nome e sobrenome.');
                return;
            }

            if (gameState.adminSettings.passwordEnabled && !password) {
                alert('A sala requer uma senha para as cartelas. Por favor, insira uma.');
                return;
            }

            if (Object.keys(gameState.players).length >= gameState.adminSettings.maxPlayers) {
                alert('A sala atingiu o nÃºmero mÃ¡ximo de participantes.');
                return;
            }

            playerState.name = name;
            playerState.surname = surname;
            playerState.roomId = roomIdFromUrl;
            playerState.status = 'registered';
            playerState.password = password; // Store password if enabled

            // Generate cards for the player
            playerState.cards = [];
            for (let i = 0; i < gameState.adminSettings.maxCardsPerPlayer; i++) {
                playerState.cards.push(generateBingoCard(playerState.id, i + 1));
            }

            // Add player to global game state (admin's view)
            gameState.players[playerState.id] = {
                id: playerState.id,
                name: `${playerState.name} ${playerState.surname}`,
                cards: playerState.cards.map(card => ({
                    id: card.id,
                    numbers: card.numbers,
                    marked: card.marked,
                    isBingo: false
                })),
                status: 'active',
                bingoType: null,
                bingoCallTimestamp: null
            };

            savePlayerState();
            saveGameState(); // Update admin's view
            updatePlayerUI();
        }

        function generateBingoCard(playerId, cardIndex) {
            const card = {
                id: `${playerId}-card-${cardIndex}`,
                numbers: [],
                marked: Array(5).fill(0).map(() => Array(5).fill(false)),
                isBingo: false
            };

            const ranges = {
                B: [1, 15],
                I: [16, 30],
                N: [31, 45],
                G: [46, 60],
                O: [61, 75]
            };
            const letters = ['B', 'I', 'N', 'G', 'O'];

            for (let col = 0; col < 5; col++) {
                const [min, max] = ranges[letters[col]];
                const columnNumbers = [];
                while (columnNumbers.length < 5) {
                    const num = Math.floor(Math.random() * (max - min + 1)) + min;
                    if (!columnNumbers.includes(num)) {
                        columnNumbers.push(num);
                    }
                }
                card.numbers.push(columnNumbers.sort((a, b) => a - b));
            }

            // Free space in the center (N3)
            card.numbers[2][2] = 'FREE';
            card.marked[2][2] = true;

            return card;
        }

        function renderPlayerCards() {
            const cardsContainer = document.getElementById('player-cards-container');
            cardsContainer.innerHTML = '';

            playerState.cards.forEach(card => {
                const cardDiv = document.createElement('div');
                cardDiv.className = `bingo-card ${card.isBingo ? 'bingo-winner' : ''}`;
                cardDiv.id = `card-${card.id}`;

                cardDiv.innerHTML = `
                    <h3>Cartela ${card.id.split('-').pop()}</h3>
                    <div class="bingo-grid">
                        <div class="bingo-cell header-cell"><span>B</span></div>
                        <div class="bingo-cell header-cell"><span>I</span></div>
                        <div class="bingo-cell header-cell"><span>N</span></div>
                        <div class="bingo-cell header-cell"><span>G</span></div>
                        <div class="bingo-cell header-cell"><span>O</span></div>
                    </div>
                    <div class="bingo-grid" id="grid-${card.id}"></div>
                    ${card.isBingo ? '<div class="bingo-overlay">BINGO!</div>' : ''}
                `;
                cardsContainer.appendChild(cardDiv);

                const gridDiv = document.getElementById(`grid-${card.id}`);
                for (let row = 0; row < 5; row++) {
                    for (let col = 0; col < 5; col++) {
                        const cellValue = card.numbers[col][row];
                        const cellDiv = document.createElement('div');
                        cellDiv.className = `bingo-cell ${card.marked[row][col] ? 'marked' : ''} ${cellValue === 'FREE' ? 'free-space' : ''}`;
                        cellDiv.dataset.cardId = card.id;
                        cellDiv.dataset.row = row;
                        cellDiv.dataset.col = col;
                        cellDiv.innerHTML = `<span>${cellValue}</span>`;

                        if (cellValue !== 'FREE' && !gameState.adminSettings.autoFillEnabled && playerState.status === 'active') {
                            cellDiv.onclick = () => toggleMark(card.id, row, col);
                        }
                        gridDiv.appendChild(cellDiv);
                    }
                }
            });
            autoMarkCards();
        }

        function toggleMark(cardId, row, col) {
            const card = playerState.cards.find(c => c.id === cardId);
            if (card && !card.isBingo && playerState.status === 'active') {
                card.marked[row][col] = !card.marked[row][col];
                savePlayerState();
                renderPlayerCards(); // Re-render to update visual
            }
        }

        function autoMarkCards() {
            if (!gameState.adminSettings.autoFillEnabled || !gameState.drawnBalls || playerState.status !== 'active') return;

            playerState.cards.forEach(card => {
                if (card.isBingo) return; // Don't mark if already bingo

                for (let col = 0; col < 5; col++) {
                    for (let row = 0; row < 5; row++) {
                        const cellValue = card.numbers[col][row];
                        if (cellValue !== 'FREE' && gameState.drawnBalls.includes(cellValue)) {
                            card.marked[row][col] = true;
                        }
                    }
                }
            });
            savePlayerState();
            renderPlayerCards();
        }

        function checkBingo(card) {
            if (card.isBingo) return null; // Already has bingo

            const marked = card.marked;
            const bingoTypes = [];

            // Check rows
            for (let r = 0; r < 5; r++) {
                if (marked[r].every(cell => cell)) bingoTypes.push('Linha');
            }

            // Check columns
            for (let c = 0; c < 5; c++) {
                if (marked.every(row => row[c])) bingoTypes.push('Coluna');
            }

            // Check diagonals
            if (marked[0][0] && marked[1][1] && marked[2][2] && marked[3][3] && marked[4][4]) bingoTypes.push('Diagonal');
            if (marked[0][4] && marked[1][3] && marked[2][2] && marked[3][1] && marked[4][0]) bingoTypes.push('Diagonal');

            // Check full house
            if (marked.every(row => row.every(cell => cell))) bingoTypes.push('Cartela Cheia');

            return bingoTypes.length > 0 ? bingoTypes[0] : null; // Return first detected type
        }

        function callBingo() {
            if (playerState.status !== 'active') {
                alert('VocÃª nÃ£o pode chamar BINGO agora.');
                return;
            }

            let foundBingo = false;
            let bingoCardId = null;
            let bingoType = null;

            for (const card of playerState.cards) {
                const type = checkBingo(card);
                if (type) {
                    foundBingo = true;
                    bingoCardId = card.id;
                    bingoType = type;
                    break;
                }
            }

            if (foundBingo) {
                playerState.status = 'bingo_called';
                savePlayerState();

                // Update admin's game state with bingo call
                gameState.bingoCall = {
                    playerId: playerState.id,
                    cardId: bingoCardId,
                    bingoType: bingoType,
                    timestamp: Date.now()
                };
                gameState.gamePhase = 'bingo_called'; // Signal admin to pause and validate
                saveGameState();

                document.getElementById('player-bingo-type').textContent = bingoType;
                document.getElementById('player-bingo-card-id').textContent = bingoCardId.split('-').pop();
                openModal('player-bingo-modal');
            } else {
                alert('VocÃª ainda nÃ£o tem BINGO!');
            }
        }

        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Periodic update from localStorage
        setInterval(() => {
            const storedState = localStorage.getItem(GAME_STATE_KEY);
            if (storedState) {
                const newGameState = JSON.parse(storedState);
                // Only update if there's a change
                if (JSON.stringify(newGameState) !== JSON.stringify(gameState)) {
                    gameState = newGameState;

                    // Update player's status if admin changed it (e.g., eliminated, winner)
                    if (gameState.players[playerState.id]) {
                        playerState.status = gameState.players[playerState.id].status;
                        // Also update player's cards from admin's state to reflect validation/marking
                        playerState.cards = gameState.players[playerState.id].cards;
                        savePlayerState();
                    }

                    updatePlayerUI();
                }
            }
        }, 2000); // Every 2 seconds

        // Initial load
        window.onload = () => {
            loadPlayerState();
            roomIdFromUrl = getUrlParameter('room');

            if (roomIdFromUrl && playerState.roomId !== roomIdFromUrl) {
                // If player is trying to join a new room, reset their state
                sessionStorage.removeItem(PLAYER_STATE_KEY);
                loadPlayerState();
                playerState.roomId = roomIdFromUrl;
                savePlayerState();
            }

            // Try to load initial game state from localStorage
            const storedState = localStorage.getItem(GAME_STATE_KEY);
            if (storedState) {
                gameState = JSON.parse(storedState);
                if (gameState.roomId !== playerState.roomId) {
                    alert('Esta sala nÃ£o existe ou foi encerrada. Por favor, obtenha um novo link.');
                    sessionStorage.removeItem(PLAYER_STATE_KEY);
                    window.location.href = 'index.html';
                    return;
                }
            } else {
                alert('Nenhuma sala de bingo ativa encontrada. Por favor, obtenha um link de um administrador.');
                sessionStorage.removeItem(PLAYER_STATE_KEY);
                window.location.href = 'index.html';
                return;
            }

            updatePlayerUI();
        };
    </script>
</body>
</html>