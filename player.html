<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bingo Digital - Jogador</title>
    <style>
        :root {
            --primary-color: #4CAF50; /* Verde */
            --secondary-color: #FFC107; /* Amarelo */
            --accent-color: #FF5722; /* Laranja */
            --text-color: #333;
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --border-color: #ddd;
            --marked-color: #FF5722; /* Laranja para marcado */
            --bingo-color: #4CAF50; /* Verde para BINGO */
            --header-bg: #333;
            --header-text: white;
        }

        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        header {
            background-color: var(--header-bg);
            color: var(--header-text);
            padding: 15px 20px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        header h1 {
            margin: 0;
            font-size: 1.8em;
        }

        .container {
            flex-grow: 1;
            padding: 20px;
            max-width: 1200px;
            margin: 20px auto;
            background-color: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .screen {
            display: none;
            padding: 20px;
        }

        .screen.active {
            display: block;
        }

        h2 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input[type="text"],
        input[type="number"],
        input[type="password"] {
            width: calc(100% - 22px);
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 1em;
        }

        .button-group {
            margin-top: 25px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 25px;
            font-size: 1em;
            font-weight: bold;
            color: white;
            background-color: var(--primary-color);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            flex-grow: 1;
            min-width: 120px;
        }

        .btn:hover {
            background-color: #388E3C;
            transform: translateY(-2px);
        }

        .btn.secondary {
            background-color: var(--secondary-color);
        }

        .btn.secondary:hover {
            background-color: #FBC02D;
        }

        .btn.danger {
            background-color: var(--accent-color);
        }

        .btn.danger:hover {
            background-color: #E64A19;
        }

        .info-box {
            background-color: #e0f7fa;
            border-left: 5px solid #00BCD4;
            padding: 15px;
            margin-top: 20px;
            border-radius: 5px;
            color: #006064;
        }

        /* Bingo Cards */
        .bingo-cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .bingo-card {
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            background-color: var(--card-bg);
            position: relative;
        }

        .card-header {
            background-color: var(--primary-color);
            color: white;
            padding: 8px 0;
            text-align: center;
            font-weight: bold;
            font-size: 1.2em;
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1px;
            background-color: var(--border-color);
        }

        .card-cell {
            width: 100%;
            padding-top: 100%; /* Makes cells square */
            position: relative;
            background-color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s ease;
            user-select: none;
        }

        .card-cell span {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .card-cell.header {
            background-color: var(--secondary-color);
            color: white;
            font-size: 1.3em;
        }

        .card-cell.free {
            background-color: #f0f0f0;
        }

        .card-cell.marked {
            background-color: var(--marked-color);
            color: white;
        }

        .card-cell.bingo-marked {
            background-color: var(--bingo-color);
            color: white;
            animation: bingoPulse 1s infinite alternate;
        }

        @keyframes bingoPulse {
            from { transform: scale(1); }
            to { transform: scale(1.05); }
        }

        .bingo-status {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 2em;
            font-weight: bold;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5);
            animation: fadeInScale 0.5s ease-out;
            z-index: 10;
            pointer-events: none; /* Allow clicks to pass through */
        }

        @keyframes fadeInScale {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        .bingo-button-container {
            text-align: center;
            margin-top: 30px;
        }

        .bingo-button-container .btn {
            width: auto;
            padding: 15px 40px;
            font-size: 1.5em;
            background-color: var(--accent-color);
        }

        .bingo-button-container .btn:hover {
            background-color: #E64A19;
        }

        /* Drawn Balls History */
        .drawn-balls-history {
            margin-top: 30px;
            border-top: 1px solid var(--border-color);
            padding-top: 20px;
        }

        .drawn-balls-history h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .drawn-balls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 8px;
            max-height: 150px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .drawn-ball-item {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 1em;
            color: var(--text-color);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .drawn-ball-item.active {
            background-color: var(--accent-color);
            color: white;
        }

        .current-ball-display {
            text-align: center;
            margin-top: 20px;
            font-size: 2em;
            font-weight: bold;
            color: var(--accent-color);
        }

        .current-ball-display span {
            display: inline-block;
            width: 80px;
            height: 80px;
            line-height: 80px;
            border-radius: 50%;
            background-color: var(--accent-color);
            color: white;
            margin-left: 10px;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
        }

        /* Modal for Winner Notification */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--card-bg);
            margin: auto;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            text-align: center;
            animation: modalOpen 0.3s ease-out;
        }

        @keyframes modalOpen {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal-content h3 {
            color: var(--bingo-color);
            margin-top: 0;
            font-size: 1.8em;
        }

        .modal-content p {
            font-size: 1.1em;
            margin-bottom: 25px;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .modal-buttons .btn {
            flex-grow: 0;
            min-width: 100px;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px auto;
                padding: 15px;
            }
            h2 {
                font-size: 1.3em;
            }
            .btn {
                padding: 10px 20px;
                font-size: 0.9em;
            }
            .bingo-cards-container {
                grid-template-columns: 1fr;
            }
            .card-cell {
                font-size: 0.9em;
            }
            .card-cell.header {
                font-size: 1.1em;
            }
            .bingo-status {
                font-size: 1.5em;
                padding: 10px 15px;
            }
            .bingo-button-container .btn {
                font-size: 1.2em;
                padding: 12px 30px;
            }
            .drawn-ball-item {
                width: 35px;
                height: 35px;
                font-size: 0.9em;
            }
            .current-ball-display {
                font-size: 1.5em;
            }
            .current-ball-display span {
                width: 60px;
                height: 60px;
                line-height: 60px;
                font-size: 1.5em;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Bingo Digital - Jogador</h1>
    </header>

    <div class="container">
        <!-- Screen 1: Player Registration -->
        <div id="registerScreen" class="screen active">
            <h2>1. Cadastre-se para Jogar</h2>
            <div class="form-group">
                <label for="playerName">Nome:</label>
                <input type="text" id="playerName" placeholder="Seu nome" required>
            </div>
            <div class="form-group">
                <label for="playerSurname">Sobrenome:</label>
                <input type="text" id="playerSurname" placeholder="Seu sobrenome" required>
            </div>
            <div class="button-group">
                <button class="btn" onclick="registerPlayer()">OK</button>
            </div>
        </div>

        <!-- Screen 1b: Room Entry Choice -->
        <div id="roomEntryScreen" class="screen">
            <h2>2. Entrar na Sala de Bingo</h2>
            <p>Como você deseja entrar na sala?</p>
            <div class="button-group">
                <button class="btn" onclick="joinRoomFromURL()">Entrar com QR Code (Link)</button>
                <button class="btn secondary" onclick="showManualRoomEntry()">Entrar Manualmente</button>
            </div>
            <div id="manualRoomEntry" style="display: none; margin-top: 20px;">
                <div class="form-group">
                    <label for="manualRoomCode">Código da Sala:</label>
                    <input type="text" id="manualRoomCode" placeholder="Digite o código da sala" required>
                </div>
                <div class="button-group">
                    <button class="btn" onclick="joinRoomManual()">Entrar na Sala</button>
                    <button class="btn danger" onclick="hideManualRoomEntry()">Cancelar</button>
                </div>
            </div>
        </div>

        <!-- Screen 2: Waiting for Game Start -->
        <div id="waitingScreen" class="screen">
            <h2>Aguarde o início do jogo, <span id="waitingPlayerName"></span>!</h2>
            <p>Você está na sala: <strong id="waitingRoomName"></strong> (Código: <span id="waitingRoomCode"></span>)</p>
            <p>O administrador ainda não iniciou a partida.</p>

            <div class="info-box">
                <p><strong>Regras da Partida:</strong></p>
                <ul>
                    <li>Vencedor continua: <span id="ruleWinnerContinuesPlayer">Não</span></li>
                    <li>Senha nas Cartelas: <span id="ruleCardPasswordPlayer">Não</span></li>
                    <li>Auto Preencher: <span id="ruleAutoFillPlayer">Sim</span></li>
                    <li>Máx. Cartelas por Jogador: <span id="ruleMaxCardsPlayer">3</span></li>
                    <li>Máx. Participantes: <span id="ruleMaxPlayersPlayer">50</span></li>
                </ul>
            </div>

            <div class="bingo-cards-container" id="waitingCardsContainer">
                <!-- Player's cards will be displayed here -->
            </div>
        </div>

        <!-- Screen 3: Game Play -->
        <div id="gameScreen" class="screen">
            <h2>Bingo em Andamento - Sala: <span id="gameRoomNamePlayer"></span></h2>
            <p>Boa sorte, <span id="gamePlayerName"></span>!</p>

            <div class="current-ball-display">
                Última Bola: <span id="currentBallPlayer">--</span>
            </div>

            <div class="bingo-cards-container" id="playerCardsContainer">
                <!-- Player's cards will be displayed here -->
            </div>

            <div class="bingo-button-container">
                <button class="btn danger" id="callBingoBtn" onclick="callBingo()">CHAMAR BINGO!</button>
            </div>

            <div class="drawn-balls-history">
                <h3>Bolas Sorteadas (<span id="drawnBallsCountPlayer">0</span>)</h3>
                <div id="drawnBallsGridPlayer" class="drawn-balls-grid">
                    <!-- Drawn balls will be displayed here -->
                </div>
            </div>
        </div>

        <!-- Winner Notification Modal -->
        <div id="winnerModal" class="modal">
            <div class="modal-content">
                <h3>BINGO!</h3>
                <p><span id="winnerNameDisplay"></span> venceu o BINGO com a cartela <span id="winnerCardIdDisplay"></span>!</p>
                <p>Parabéns!</p>
                <div class="modal-buttons">
                    <button class="btn" onclick="closeWinnerModal()">OK</button>
                </div>
            </div>
        </div>

        <!-- Tie-breaker Notification Modal -->
        <div id="tieBreakerModal" class="modal">
            <div class="modal-content">
                <h3>DESEMPATE!</h3>
                <p>Você está participando de um desempate. Aguarde as instruções do administrador.</p>
                <div class="modal-buttons">
                    <button class="btn" onclick="closeTieBreakerModal()">OK</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Base URL para o GitHub Pages
        const BASE_URL = "https://wcorsini79.github.io/Bingool/";

        let playerState = {
            currentScreen: 'registerScreen',
            playerId: null,
            playerName: '',
            playerSurname: '',
            roomCode: null,
            cards: [], // { id: '', numbers: [], marked: [], bingoType: null, active: true }
            bingoCalled: false,
            hasWon: false
        };

        let adminState = null; // Will be synced from localStorage

        // --- Utility Functions ---
        function generatePlayerId() {
            return 'P' + Math.random().toString(36).substring(2, 9).toUpperCase();
        }

        function savePlayerState() {
            sessionStorage.setItem(`bingo_player_${playerState.playerId}`, JSON.stringify(playerState));
        }

        function loadPlayerState() {
            const storedState = sessionStorage.getItem(`bingo_player_${playerState.playerId}`);
            if (storedState) {
                playerState = JSON.parse(storedState);
                return true;
            }
            return false;
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
            playerState.currentScreen = screenId;
            savePlayerState();
            updateUI();
        }

        function getBallColor(number) {
            if (number >= 1 && number <= 15) return '#4CAF50'; // B - Green
            if (number >= 16 && number <= 30) return '#2196F3'; // I - Blue
            if (number >= 31 && number <= 45) return '#FFC107'; // N - Yellow
            if (number >= 46 && number <= 60) return '#FF5722'; // G - Orange
            if (number >= 61 && number <= 75) return '#9C27B0'; // O - Purple
            return '#e0e0e0'; // Default
        }

        // --- Card Generation ---
        function generateBingoCard() {
            const card = {
                id: Math.random().toString(36).substring(2, 9).toUpperCase(),
                numbers: [],
                marked: [],
                bingoType: null, // 'row', 'col', 'diag1', 'diag2', 'full'
                active: true
            };
            const columns = {
                B: generateUniqueNumbers(1, 15, 5),
                I: generateUniqueNumbers(16, 30, 5),
                N: generateUniqueNumbers(31, 45, 5),
                G: generateUniqueNumbers(46, 60, 5),
                O: generateUniqueNumbers(61, 75, 5)
            };

            const letters = ['B', 'I', 'N', 'G', 'O'];
            for (let i = 0; i < 5; i++) {
                for (let j = 0; j < 5; j++) {
                    if (i === 2 && j === 2) { // Free space
                        card.numbers.push('FREE');
                        card.marked.push(true);
                    } else {
                        card.numbers.push(columns[letters[j]].pop());
                        card.marked.push(false);
                    }
                }
            }
            return card;
        }

        function generateUniqueNumbers(min, max, count) {
            const numbers = [];
            while (numbers.length < count) {
                const num = Math.floor(Math.random() * (max - min + 1)) + min;
                if (!numbers.includes(num)) {
                    numbers.push(num);
                }
            }
            return numbers.sort((a, b) => a - b);
        }

        function renderCards(containerId, cards) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            if (!cards || cards.length === 0) {
                container.innerHTML = '<p>Nenhuma cartela gerada ainda.</p>';
                return;
            }

            cards.forEach(card => {
                const cardDiv = document.createElement('div');
                cardDiv.classList.add('bingo-card');
                cardDiv.dataset.cardId = card.id;

                let bingoStatusHtml = '';
                if (card.bingoType) {
                    bingoStatusHtml = `<div class="bingo-status">BINGO!</div>`;
                } else if (!card.active) {
                    bingoStatusHtml = `<div class="bingo-status" style="background-color: rgba(0,0,0,0.5);">INATIVA</div>`;
                }

                cardDiv.innerHTML = `
                    <div class="card-header">Cartela ${card.id}</div>
                    <div class="card-grid">
                        <div class="card-cell header">B</div>
                        <div class="card-cell header">I</div>
                        <div class="card-cell header">N</div>
                        <div class="card-cell header">G</div>
                        <div class="card-cell header">O</div>
                        ${card.numbers.map((num, index) => `
                            <div class="card-cell ${num === 'FREE' ? 'free' : ''} ${card.marked[index] ? 'marked' : ''}"
                                 data-number="${num}" data-index="${index}"
                                 onclick="markNumber(this, '${card.id}')">
                                <span>${num}</span>
                            </div>
                        `).join('')}
                    </div>
                    ${bingoStatusHtml}
                `;
                container.appendChild(cardDiv);
            });
        }

        function markNumber(cell, cardId) {
                return; // Cannot mark if game not started, auto-fill enabled, or card inactive
            }

            const cardIndex = playerState.cards.findIndex(c => c.id === cardId);
            if (cardIndex === -1) return;

            const index = parseInt(cell.dataset.index);
            const number = cell.dataset.number;

            if (number === 'FREE') return; // Free space is always marked

            playerState.cards[cardIndex].marked[index] = !playerState.cards[cardIndex].marked[index];
            savePlayerState();
            updateUI();
        }

        function checkBingo(card) {
            const marked = card.marked;
            const numbers = card.numbers;

            // Helper to check if all indices are marked
            const allMarked = (indices) => indices.every(i => marked[i]);

            // Rows
            for (let i = 0; i < 5; i++) {
                if (allMarked([i * 5, i * 5 + 1, i * 5 + 2, i * 5 + 3, i * 5 + 4])) return 'row';
            }
            // Columns
            for (let i = 0; i < 5; i++) {
                if (allMarked([i, i + 5, i + 10, i + 15, i + 20])) return 'col';
            }
            // Diagonals
            if (allMarked([0, 6, 12, 18, 24])) return 'diag1'; // Top-left to bottom-right
            if (allMarked([4, 8, 12, 16, 20])) return 'diag2'; // Top-right to bottom-left

            // Full card (all marked)
            if (marked.every(m => m)) return 'full';

            return null;
        }

        // --- Screen 1: Player Registration ---
        function registerPlayer() {
            const name = document.getElementById('playerName').value.trim();
            const surname = document.getElementById('playerSurname').value.trim();

            if (!name || !surname) {
                alert('Por favor, preencha seu nome e sobrenome.');
                return;
            }

            playerState.playerName = name;
            playerState.playerSurname = surname;
            playerState.playerId = generatePlayerId();
            savePlayerState();

            // Check if room code came from URL
            const urlParams = new URLSearchParams(window.location.search);
            const roomCodeFromURL = urlParams.get('room');

            if (roomCodeFromURL) {
                playerState.roomCode = roomCodeFromURL;
                joinRoomFromURL(); // Directly attempt to join
            } else {
                showScreen('roomEntryScreen');
            }
        }

        // --- Screen 1b: Room Entry Choice ---
        function showManualRoomEntry() {
            document.getElementById('manualRoomEntry').style.display = 'block';
            document.querySelector('#roomEntryScreen .button-group').style.display = 'none';
        }

        function hideManualRoomEntry() {
            document.getElementById('manualRoomEntry').style.display = 'none';
            document.querySelector('#roomEntryScreen .button-group').style.display = 'flex';
            document.getElementById('manualRoomCode').value = '';
        }

        function joinRoomFromURL() {
            if (!playerState.roomCode) {
                alert('Nenhum código de sala encontrado no link.');
                hideManualRoomEntry();
                return;
            }
            joinRoom(playerState.roomCode);
        }

        function joinRoomManual() {
            const roomCode = document.getElementById('manualRoomCode').value.trim().toUpperCase();
            if (!roomCode) {
                alert('Por favor, digite o código da sala.');
                return;
            }
            playerState.roomCode = roomCode;
            joinRoom(roomCode);
        }

        function joinRoom(roomCode) {
            const adminData = localStorage.getItem(`bingo_admin_${roomCode}`);
            if (!adminData) {
                alert('Sala não encontrada ou código inválido.');
                playerState.roomCode = null; // Clear invalid room code
                savePlayerState();
                hideManualRoomEntry();
                return;
            }

            adminState = JSON.parse(adminData);

            if (Object.keys(adminState.players).length >= adminState.config.maxPlayers) {
                alert('A sala atingiu o número máximo de participantes.');
                playerState.roomCode = null;
                savePlayerState();
                hideManualRoomEntry();
                return;
            }

            // Add player to adminState if not already there
            if (!adminState.players[playerState.playerId]) {
                adminState.players[playerState.playerId] = {
                    name: `${playerState.playerName} ${playerState.playerSurname}`,
                    cards: [],
                    active: true,
                    calledBingo: false,
                    tieBreakerResult: null
                };
            }

            // Generate cards for the player if they don't have any or if config changed
            if (playerState.cards.length === 0 || playerState.cards.length !== adminState.config.maxCardsPerPlayer) {
                playerState.cards = [];
                for (let i = 0; i < adminState.config.maxCardsPerPlayer; i++) {
                    const newCard = generateBingoCard();
                    playerState.cards.push(newCard);
                    adminState.cards[newCard.id] = {
                        playerId: playerState.playerId,
                        numbers: newCard.numbers,
                        marked: newCard.marked,
                        bingoType: null,
                        active: true
                    };
                    adminState.players[playerState.playerId].cards.push(newCard.id);
                }
            } else {
                // Update adminState.cards with player's current cards
                playerState.cards.forEach(card => {
                    adminState.cards[card.id] = {
                        playerId: playerState.playerId,
                        numbers: card.numbers,
                        marked: card.marked,
                        bingoType: card.bingoType,
                        active: card.active
                    };
                });
            }

            localStorage.setItem(`bingo_admin_${roomCode}`, JSON.stringify(adminState));
            savePlayerState();
            showScreen('waitingScreen');
        }

        // --- UI Update Function ---
        function updateUI() {
            // Update header with player name
            document.querySelector('header h1').textContent = `Bingo Digital - ${playerState.playerName || 'Jogador'}`;

            // Update Waiting Screen
            if (playerState.currentScreen === 'waitingScreen') {
                document.getElementById('waitingPlayerName').textContent = playerState.playerName;
                document.getElementById('waitingRoomName').textContent = adminState?.roomName || 'N/A';
                document.getElementById('waitingRoomCode').textContent = playerState.roomCode || 'N/A';

                if (adminState) {
                    document.getElementById('ruleWinnerContinuesPlayer').textContent = adminState.config.winnerContinues ? 'Sim' : 'Não';
                    document.getElementById('ruleCardPasswordPlayer').textContent = adminState.config.enableCardPassword ? 'Sim' : 'Não';
                    document.getElementById('ruleAutoFillPlayer').textContent = adminState.config.enableAutoFill ? 'Sim' : 'Não';
                    document.getElementById('ruleMaxCardsPlayer').textContent = adminState.config.maxCardsPerPlayer;
                    document.getElementById('ruleMaxPlayersPlayer').textContent = adminState.config.maxPlayers;
                }
                renderCards('waitingCardsContainer', playerState.cards);
            }

            // Update Game Screen
            if (playerState.currentScreen === 'gameScreen') {
                document.getElementById('gameRoomNamePlayer').textContent = adminState?.roomName || 'N/A';
                document.getElementById('gamePlayerName').textContent = playerState.playerName;

                const currentBallDisplay = document.getElementById('currentBallPlayer');
                if (adminState && adminState.ballsDrawn.length > 0) {
                    currentBallDisplay.textContent = adminState.ballsDrawn[adminState.ballsDrawn.length - 1];
                    currentBallDisplay.style.backgroundColor = getBallColor(adminState.ballsDrawn[adminState.ballsDrawn.length - 1]);
                    currentBallDisplay.style.color = 'white';
                } else {
                    currentBallDisplay.textContent = '--';
                    currentBallDisplay.style.backgroundColor = 'transparent';
                    currentBallDisplay.style.color = var('--accent-color');
                }

                renderCards('playerCardsContainer', playerState.cards);

                const drawnBallsGrid = document.getElementById('drawnBallsGridPlayer');
                drawnBallsGrid.innerHTML = '';
                if (adminState) {
                    adminState.ballsDrawn.forEach(ball => {
                        const ballElement = document.createElement('div');
                        ballElement.classList.add('drawn-ball-item', 'active');
                        ballElement.textContent = ball;
                        ballElement.style.backgroundColor = getBallColor(ball);
                        drawnBallsGrid.appendChild(ballElement);
                    });
                    document.getElementById('drawnBallsCountPlayer').textContent = adminState.ballsDrawn.length;
                }

                // Disable BINGO button if player already won or card inactive
                const callBingoBtn = document.getElementById('callBingoBtn');
                const anyCardActive = playerState.cards.some(card => card.active);
                callBingoBtn.disabled = playerState.hasWon || !anyCardActive;
                callBingoBtn.textContent = playerState.hasWon ? 'Você já venceu!' : 'CHAMAR BINGO!';
            }
        }

        // --- Game Logic ---
        function autoMarkNumbers() {
            if (!adminState || !adminState.gameStarted || !adminState.config.enableAutoFill) return;

            playerState.cards.forEach(card => {
                if (!card.active) return; // Skip inactive cards
                card.numbers.forEach((num, index) => {
                    if (num !== 'FREE' && adminState.ballsDrawn.includes(num)) {
                        card.marked[index] = true;
                    }
                });
            });
            savePlayerState();
        }

        function callBingo() {
                alert('Você não pode chamar BINGO agora.');
                return;
            }

            let foundBingo = false;
            for (const card of playerState.cards) {
                if (!card.active) continue; // Skip inactive cards
                const bingoType = checkBingo(card);
                if (bingoType) {
                    foundBingo = true;
                    card.bingoType = bingoType; // Mark card with bingo type
                    playerState.bingoCalled = true;
                    playerState.hasWon = true; // Player has won (at least one prize)

                    // Notify admin
                    const adminData = JSON.parse(localStorage.getItem(`bingo_admin_${playerState.roomCode}`));
                    if (adminData) {
                        adminData.bingoCalled = {
                            playerId: playerState.playerId,
                            cardId: card.id,
                            type: bingoType
                        };
                        localStorage.setItem(`bingo_admin_${playerState.roomCode}`, JSON.stringify(adminData));
                    }
                    alert(`BINGO na cartela ${card.id}! Aguarde a validação do administrador.`);
                    break; // Only call bingo once per player
                }
            }

            if (!foundBingo) {
                alert('Você ainda não tem BINGO. Continue jogando!');
            }
            savePlayerState();
            updateUI();
        }

        // --- Modals ---
        function showWinnerModal(winnerName, cardId) {
            document.getElementById('winnerNameDisplay').textContent = winnerName;
            document.getElementById('winnerCardIdDisplay').textContent = cardId;
            document.getElementById('winnerModal').style.display = 'flex';
        }

        function closeWinnerModal() {
            document.getElementById('winnerModal').style.display = 'none';
        }

        function showTieBreakerModal() {
            document.getElementById('tieBreakerModal').style.display = 'flex';
        }

        function closeTieBreakerModal() {
            document.getElementById('tieBreakerModal').style.display = 'none';
        }

        // --- Synchronization Loop ---
        function syncPlayerState() {
            if (!playerState.roomCode) return;

            const adminData = localStorage.getItem(`bingo_admin_${playerState.roomCode}`);
            if (!adminData) {
                alert('A sala foi encerrada pelo administrador.');
                sessionStorage.removeItem(`bingo_player_${playerState.playerId}`);
                window.location.href = BASE_URL + 'index.html'; // Redirect to home
                return;
            }

            const newAdminState = JSON.parse(adminData);

            // Update player's cards based on admin's view (e.g., if admin marked a card inactive)
            playerState.cards.forEach(card => {
                if (newAdminState.cards[card.id]) {
                    card.active = newAdminState.cards[card.id].active;
                    card.bingoType = newAdminState.cards[card.id].bingoType;
                }
            });

            // Update player's active status based on admin's view
            if (newAdminState.players[playerState.playerId]) {
                playerState.hasWon = !newAdminState.players[playerState.playerId].active; // If admin deactivated, player has won and cannot play further
                playerState.bingoCalled = newAdminState.players[playerState.playerId].calledBingo; // Reset if admin invalidated
            }

            adminState = newAdminState; // Update local adminState copy

            // Auto-mark numbers if enabled
            autoMarkNumbers();

            // Screen transitions based on admin state
            if (adminState.gameStarted && playerState.currentScreen !== 'gameScreen') {
                showScreen('gameScreen');
            } else if (!adminState.gameStarted && playerState.currentScreen === 'gameScreen') {
                // Game ended or paused, go back to waiting
                showScreen('waitingScreen');
            }

            // Check for winner notification
            if (adminState.bingoCalled && adminState.bingoCalled.playerId !== playerState.playerId && !document.getElementById('winnerModal').style.display.includes('flex')) {
                showWinnerModal(adminState.players[adminState.bingoCalled.playerId]?.name, adminState.bingoCalled.cardId);
            } else if (!adminState.bingoCalled && document.getElementById('winnerModal').style.display.includes('flex')) {
                closeWinnerModal(); // Hide if admin cleared bingo call
            }

            // Check for tie-breaker
            if (adminState.tieBreaker.active && adminState.tieBreaker.players[playerState.playerId] && !document.getElementById('tieBreakerModal').style.display.includes('flex')) {
                showTieBreakerModal();
            } else if (!adminState.tieBreaker.active && document.getElementById('tieBreakerModal').style.display.includes('flex')) {
                closeTieBreakerModal();
            }

            savePlayerState();
            updateUI();
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            // Try to load player ID from sessionStorage first
            const storedPlayerId = sessionStorage.getItem('bingo_player_id');
            if (storedPlayerId) {
                playerState.playerId = storedPlayerId;
                if (loadPlayerState()) {
                    // Check if room code came from URL
                    const urlParams = new URLSearchParams(window.location.search);
                    const roomCodeFromURL = urlParams.get('room');
                    if (roomCodeFromURL && playerState.roomCode !== roomCodeFromURL) {
                        // If player was in a different room, or new room code, update
                        playerState.roomCode = roomCodeFromURL;
                        joinRoom(roomCodeFromURL); // Re-join with new room code
                    } else if (playerState.roomCode) {
                        // If player has a room code, try to re-join
                        joinRoom(playerState.roomCode);
                    } else {
                        // No room code, go to room entry
                        showScreen('roomEntryScreen');
                    }
                } else {
                    // Player ID exists but no state, go to register
                    showScreen('registerScreen');
                }
            } else {
                showScreen('registerScreen');
            }

            // Save player ID for future sessions
            if (playerState.playerId) {
                sessionStorage.setItem('bingo_player_id', playerState.playerId);
            }

            setInterval(syncPlayerState, 2000); // Sync every 2 seconds
        });
    </script>
</body>
</html>