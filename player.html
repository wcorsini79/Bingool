<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bingo Digital - Jogador</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #f093fb, #f5576c); /* Gradiente rosa/roxo */
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
            max-width: 900px;
            width: 100%;
            text-align: center;
            position: relative;
        }
        h1, h2 {
            color: #fff;
            margin-bottom: 20px;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
        }
        .screen {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }
        .screen.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #eee;
        }
        .form-group input[type="text"] {
            width: calc(100% - 20px);
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1em;
            box-sizing: border-box;
            background: rgba(255,255,255,0.9);
            color: #333;
        }
        .btn {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #333;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
        }
        .btn-primary {
            background: linear-gradient(45deg, #f5576c, #f093fb);
            color: #fff;
        }
        .btn-primary:hover {
            background: linear-gradient(45deg, #f093fb, #f5576c);
        }
        .btn-success {
            background: linear-gradient(45deg, #28a745, #218838);
            color: #fff;
        }
        .btn-success:hover {
            background: linear-gradient(45deg, #218838, #28a745);
        }
        .message {
            font-size: 1.5em;
            margin-top: 30px;
            color: #eee;
        }
        .rules-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            text-align: left;
            color: #eee;
        }
        .rules-section h3 {
            color: #fff;
            margin-top: 0;
            border-bottom: 1px solid rgba(255,255,255,0.3);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .rules-section ul {
            list-style: none;
            padding: 0;
        }
        .rules-section ul li {
            margin-bottom: 8px;
            padding-left: 25px;
            position: relative;
        }
        .rules-section ul li::before {
            content: '•';
            color: #FFD700;
            font-size: 1.2em;
            position: absolute;
            left: 0;
            top: -2px;
        }

        /* Game Screen */
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .game-header h2 {
            margin: 0;
            font-size: 1.8em;
        }
        .last-drawn-ball {
            background: #FFD700;
            color: #333;
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 1.5em;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .bingo-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            color: #333;
            text-align: center;
            position: relative;
        }
        .bingo-card h3 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #f5576c;
        }
        .bingo-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
        }
        .bingo-cell {
            width: 100%;
            padding-top: 100%; /* Makes cells square */
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #eee;
            border-radius: 5px;
            font-weight: bold;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .bingo-cell span {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .bingo-cell.header {
            background: #f093fb;
            color: #fff;
            font-size: 1.2em;
        }
        .bingo-cell.free {
            background: #FFD700;
            color: #333;
        }
        .bingo-cell.marked {
            background: #28a745;
            color: #fff;
        }
        .bingo-cell.marked::after {
            content: '✓';
            position: absolute;
            font-size: 1.5em;
            color: rgba(255,255,255,0.5);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .bingo-card.winner {
            border: 5px solid #FFD700;
            box-shadow: 0 0 20px #FFD700;
            animation: pulse 1s infinite alternate;
        }
        @keyframes pulse {
            from { transform: scale(1); }
            to { transform: scale(1.02); }
        }
        .bingo-card .bingo-status {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3em;
            font-weight: bold;
            color: #28a745;
            text-shadow: 2px 2px 5px rgba(0,0,0,0.5);
            z-index: 10;
            opacity: 0;
            animation: bingoPop 1s forwards;
        }
        @keyframes bingoPop {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            70% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        .drawn-numbers {
            margin-top: 30px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            text-align: left;
            border: 1px solid rgba(255,255,255,0.2);
            color: #eee;
        }
        .drawn-numbers h3 {
            color: #fff;
            margin-top: 0;
            margin-bottom: 15px;
        }
        .drawn-numbers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 8px;
        }
        .drawn-number-item {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 5px;
            padding: 8px 0;
            font-weight: bold;
            font-size: 0.9em;
            color: #fff;
            text-align: center;
        }
        .drawn-number-item.last-drawn {
            background: #FFD700;
            border-color: #FFA500;
            color: #333;
            animation: highlight 1s infinite alternate;
        }
        @keyframes highlight {
            from { transform: scale(1); }
            to { transform: scale(1.1); }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 90%;
            text-align: center;
            animation: slideIn 0.4s ease-out;
            color: #333;
        }
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .modal-content h3 {
            color: #f5576c;
            margin-bottom: 20px;
            font-size: 1.8em;
        }
        .modal-content p {
            font-size: 1.1em;
            margin-bottom: 15px;
            color: #555;
        }
        .modal-buttons {
            margin-top: 25px;
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        .modal-buttons .btn {
            padding: 10px 20px;
            font-size: 1em;
        }
        .winner-notification {
            background: #28a745;
            color: #fff;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 1.2em;
            font-weight: bold;
            animation: pulse 1s infinite alternate;
        }
        .game-over-message {
            background: #f5576c;
            color: #fff;
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
            font-size: 1.8em;
            font-weight: bold;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            h1 {
                font-size: 1.8em;
            }
            .btn {
                padding: 10px 20px;
                font-size: 1em;
            }
            .game-header {
                flex-direction: column;
                align-items: flex-start;
            }
            .last-drawn-ball {
                margin-top: 10px;
            }
            .cards-container {
                grid-template-columns: 1fr;
            }
            .bingo-cell {
                font-size: 1em;
            }
            .drawn-numbers-grid {
                grid-template-columns: repeat(auto-fill, minmax(35px, 1fr));
                gap: 5px;
            }
            .modal-content {
                padding: 20px;
            }
            .modal-content h3 {
                font-size: 1.5em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Bingo Digital - Jogador</h1>

        <!-- Screen 1: Cadastro do Jogador -->
        <div id="screen1" class="screen active">
            <h2>Entrar na Sala</h2>
            <p>Sala: <strong id="playerRoomCodeDisplay"></strong></p>
            <div class="form-group">
                <label for="playerName">Nome:</label>
                <input type="text" id="playerName" placeholder="Seu Nome" required>
            </div>
            <div class="form-group">
                <label for="playerSurname">Sobrenome:</label>
                <input type="text" id="playerSurname" placeholder="Seu Sobrenome" required>
            </div>
            <button class="btn btn-primary" onclick="joinRoom()">Entrar na Sala</button>
        </div>

        <!-- Screen 2: Espera -->
        <div id="screen2" class="screen">
            <h2>Aguarde o início do jogo...</h2>
            <p class="message">Você está na sala: <strong id="waitingRoomName"></strong></p>
            <div class="rules-section">
                <h3>Regras da Partida:</h3>
                <ul id="gameRulesList">
                    <li>Vencedor continua: <span id="ruleWinnerContinues">Não</span></li>
                    <li>Auto Preencher: <span id="ruleAutoFill">Sim</span></li>
                    <li>Máx. Cartelas por Jogador: <span id="ruleMaxCards">5</span></li>
                    <li>Máx. Participantes: <span id="ruleMaxPlayers">50</span></li>
                </ul>
            </div>
            <p class="message">Aguardando o administrador iniciar o jogo.</p>
        </div>

        <!-- Screen 3: Jogo -->
        <div id="screen3" class="screen">
            <div class="game-header">
                <h2>Sala: <span id="gamePlayerRoomName"></span></h2>
                <div class="last-drawn-ball">Última Bola: <span id="playerCurrentBall">--</span></div>
            </div>
            <button class="btn btn-success" onclick="callBingo()">Chamar BINGO!</button>
            <button class="btn" onclick="generateNewCard()">Gerar Nova Cartela</button>
            <div id="winnerNotification" class="winner-notification" style="display: none;"></div>
            <div id="gameOverMessage" class="game-over-message" style="display: none;">O jogo acabou!</div>

            <div class="cards-container" id="playerCardsContainer">
                <!-- Cartelas de bingo serão geradas aqui -->
            </div>

            <div class="drawn-numbers">
                <h3>Bolas Sorteadas:</h3>
                <div class="drawn-numbers-grid" id="playerDrawnNumbersGrid">
                    <!-- Números sorteados aparecerão aqui -->
                </div>
            </div>
        </div>

        <!-- Modal de BINGO Chamado -->
        <div id="bingoCalledModal" class="modal">
            <div class="modal-content">
                <h3>BINGO CHAMADO!</h3>
                <p>Aguardando validação do administrador.</p>
                <div class="modal-buttons">
                    <button class="btn btn-primary" onclick="closeBingoCalledModal()">OK</button>
                </div>
            </div>
        </div>

        <!-- Modal de Validação de BINGO -->
        <div id="bingoValidationResultModal" class="modal">
            <div class="modal-content">
                <h3 id="bingoValidationTitle"></h3>
                <p id="bingoValidationMessage"></p>
                <div class="modal-buttons">
                    <button class="btn btn-primary" onclick="closeBingoValidationResultModal()">OK</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Variáveis Globais e Estado ---
        let playerState = {
            roomCode: null,
            playerId: null,
            name: '',
            surname: '',
            cards: [], // [{ id: 'card1', numbers: [[B1,B2...],[I1,I2...]], marked: [[true,false...]] }]
            status: 'active', // 'active', 'won', 'lost-tie'
            lastAdminUpdate: 0,
            bingoCalled: false,
            bingoValidated: null // null: pending, true: valid, false: invalid
        };

        let adminState = {}; // Copia do estado do admin para leitura

        const BINGO_LETTERS = ['B', 'I', 'N', 'G', 'O'];
        const BINGO_RANGES = {
            'B': [1, 15],
            'I': [16, 30],
            'N': [31, 45],
            'G': [46, 60],
            'O': [61, 75]
        };

        // --- Funções de Sincronização e Persistência ---
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\[').replace(/[\]]/, '\]');
            const regex = new RegExp('[\?&]' + name + '=([^&#]*)');
            const results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        function generatePlayerId() {
            return 'player_' + Math.random().toString(36).substring(2, 11);
        }

        function savePlayerState() {
            if (playerState.roomCode && playerState.playerId) {
                sessionStorage.setItem(`bingo_player_${playerState.roomCode}_${playerState.playerId}`, JSON.stringify(playerState));
            }
        }

        function loadPlayerState() {
            const roomCode = getUrlParameter('room');
            if (roomCode) {
                playerState.roomCode = roomCode;
                document.getElementById('playerRoomCodeDisplay').textContent = roomCode;

                // Try to load existing player state for this room
                for (let i = 0; i < sessionStorage.length; i++) {
                    const key = sessionStorage.key(i);
                    if (key.startsWith(`bingo_player_${roomCode}_`)) {
                        playerState = JSON.parse(sessionStorage.getItem(key));
                        return true;
                    }
                }
            }
            return false;
        }

        function updateAdminPlayers() {
            if (!adminState.roomCode || !playerState.playerId) return;

            // Get the latest admin state to avoid overwriting
            const adminData = localStorage.getItem(`bingo_admin_${adminState.roomCode}`);
            if (adminData) {
                let currentAdminState = JSON.parse(adminData);
                currentAdminState.players[playerState.playerId] = {
                    name: playerState.name,
                    surname: playerState.surname,
                    cards: playerState.cards.map(card => ({ id: card.id, marked: card.marked })), // Only send necessary card data
                    status: playerState.status
                };
                currentAdminState.lastUpdate = Date.now();
                localStorage.setItem(`bingo_admin_${adminState.roomCode}`, JSON.stringify(currentAdminState));
            }
        }

        function updateUI() {
            // Update rules on waiting screen
            document.getElementById('waitingRoomName').textContent = adminState.roomName || 'N/A';
            document.getElementById('ruleWinnerContinues').textContent = adminState.winnerContinues ? 'Sim' : 'Não';
            document.getElementById('ruleAutoFill').textContent = adminState.enableAutoFill ? 'Sim' : 'Não';
            document.getElementById('ruleMaxCards').textContent = adminState.maxCardsPerPlayer;
            document.getElementById('ruleMaxPlayers').textContent = adminState.maxParticipants;

            // Update game screen header
            document.getElementById('gamePlayerRoomName').textContent = adminState.roomName || 'N/A';
            document.getElementById('playerCurrentBall').textContent = adminState.drawnNumbers.length > 0 ? adminState.drawnNumbers[adminState.drawnNumbers.length - 1] : '--';
            updatePlayerDrawnNumbersGrid();

            // Render cards
            renderPlayerCards();

            // Handle game state changes
            if (adminState.gameEnded) {
                showScreen('screen3'); // Stay on game screen
                document.getElementById('gameOverMessage').style.display = 'block';
                document.getElementById('winnerNotification').style.display = 'none';
                document.querySelector('.btn-success').style.display = 'none'; // Hide call bingo button
                document.querySelector('.btn[onclick="generateNewCard()"]').style.display = 'none'; // Hide generate card button
                return;
            } else {
                document.getElementById('gameOverMessage').style.display = 'none';
                document.querySelector('.btn-success').style.display = 'inline-block';
                document.querySelector('.btn[onclick="generateNewCard()"]').style.display = 'inline-block';
            }

            if (adminState.gameStarted && playerState.status === 'active') {
                showScreen('screen3');
                // Auto-fill logic
                if (adminState.enableAutoFill) {
                    autoMarkNumbers();
                }
            } else if (adminState.gameStarted && playerState.status !== 'active') {
                showScreen('screen3'); // Stay on game screen, but disable actions
                document.querySelector('.btn-success').disabled = true;
                document.querySelector('.btn[onclick="generateNewCard()"]').disabled = true;
                if (playerState.status === 'won') {
                    document.getElementById('winnerNotification').textContent = `Parabéns, você ganhou BINGO!`;
                    document.getElementById('winnerNotification').style.display = 'block';
                } else if (playerState.status === 'lost-tie') {
                    document.getElementById('winnerNotification').textContent = `Você participou do desempate, mas não venceu esta rodada.`;
                    document.getElementById('winnerNotification').style.display = 'block';
                }
            } else if (!adminState.gameStarted && playerState.roomCode) {
                showScreen('screen2');
            } else {
                showScreen('screen1');
            }

            // Check for bingo validation results
            const playerBingoCall = adminState.bingoCalls.find(
                call => call.playerId === playerState.playerId && call.validated !== null && call.validated !== playerState.bingoValidated
            );
            if (playerBingoCall) {
                playerState.bingoValidated = playerBingoCall.validated;
                if (playerBingoCall.validated) {
                    showBingoValidationResultModal('BINGO VALIDADO!', 'Parabéns! Seu BINGO foi validado pelo administrador.');
                    playerState.status = 'won';
                } else {
                    showBingoValidationResultModal('BINGO INVALIDADO!', 'Seu BINGO não foi validado. Verifique sua cartela e tente novamente.');
                    playerState.bingoCalled = false; // Allow calling bingo again
                }
                savePlayerState();
            }

            // Hide bingo called modal if admin has processed it
            const pendingCallForPlayer = adminState.bingoCalls.find(
                call => call.playerId === playerState.playerId && call.validated === null
            );
            if (!pendingCallForPlayer && document.getElementById('bingoCalledModal').classList.contains('active')) {
                closeBingoCalledModal();
            }
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        // --- Funções de Jogo ---
        function joinRoom() {
            const name = document.getElementById('playerName').value.trim();
            const surname = document.getElementById('playerSurname').value.trim();
            if (!name || !surname) {
                alert('Por favor, insira seu nome e sobrenome.');
                return;
            }

            playerState.name = name;
            playerState.surname = surname;
            if (!playerState.playerId) {
                playerState.playerId = generatePlayerId();
            }
            playerState.status = 'active';
            savePlayerState();
            updateAdminPlayers(); // Notify admin about new player
            generateNewCard(); // Generate initial card
            updateUI();
        }

        function generateNewCard() {
            if (playerState.status !== 'active') {
                alert('Você não pode gerar novas cartelas no momento.');
                return;
            }
            if (playerState.cards.length >= adminState.maxCardsPerPlayer) {
                alert(`Você atingiu o limite de ${adminState.maxCardsPerPlayer} cartelas por jogador.`);
                return;
            }

            const card = {
                id: `card_${playerState.cards.length + 1}_${Date.now()}`,
                numbers: [],
                marked: Array(5).fill(0).map(() => Array(5).fill(false))
            };

            // Generate numbers for the card
            for (let col = 0; col < 5; col++) {
                const letter = BINGO_LETTERS[col];
                const [min, max] = BINGO_RANGES[letter];
                const columnNumbers = [];
                while (columnNumbers.length < 5) {
                    const num = Math.floor(Math.random() * (max - min + 1)) + min;
                    if (!columnNumbers.includes(num)) {
                        columnNumbers.push(num);
                    }
                }
                card.numbers.push(columnNumbers);
            }
            card.numbers[2][2] = 'FREE'; // Free space
            card.marked[2][2] = true; // Free space is always marked

            playerState.cards.push(card);
            savePlayerState();
            updateAdminPlayers(); // Update admin with new card
            renderPlayerCards();
        }

        function renderPlayerCards() {
            const container = document.getElementById('playerCardsContainer');
            container.innerHTML = '';

            playerState.cards.forEach((card, cardIndex) => {
                const cardDiv = document.createElement('div');
                cardDiv.classList.add('bingo-card');
                if (playerState.status === 'won') {
                    cardDiv.classList.add('winner');
                    cardDiv.innerHTML += '<div class="bingo-status">BINGO!</div>';
                }
                cardDiv.innerHTML += `<h3>Cartela #${cardIndex + 1}</h3>`;

                const gridDiv = document.createElement('div');
                gridDiv.classList.add('bingo-grid');

                // Add headers
                BINGO_LETTERS.forEach(letter => {
                    const headerCell = document.createElement('div');
                    headerCell.classList.add('bingo-cell', 'header');
                    headerCell.innerHTML = `<span>${letter}</span>`;
                    gridDiv.appendChild(headerCell);
                });

                // Add numbers
                for (let row = 0; row < 5; row++) {
                    for (let col = 0; col < 5; col++) {
                        const cell = document.createElement('div');
                        cell.classList.add('bingo-cell');
                        cell.dataset.cardIndex = cardIndex;
                        cell.dataset.rowIndex = row;
                        cell.dataset.colIndex = col;

                        const number = card.numbers[col][row];
                        cell.innerHTML = `<span>${number}</span>`;

                        if (number === 'FREE') {
                            cell.classList.add('free');
                        }
                        if (card.marked[col][row]) {
                            cell.classList.add('marked');
                        }

                        cell.addEventListener('click', () => markNumber(cardIndex, row, col));
                        gridDiv.appendChild(cell);
                    }
                }
                cardDiv.appendChild(gridDiv);
                container.appendChild(cardDiv);
            });
        }

        function markNumber(cardIndex, rowIndex, colIndex) {
            if (adminState.enableAutoFill || playerState.status !== 'active' || adminState.gameEnded) return;

            const card = playerState.cards[cardIndex];
            if (!card) return;

            const number = card.numbers[colIndex][rowIndex];
            if (number === 'FREE') return; // Cannot unmark free space

            // Check if the number has been drawn by the admin
            if (!adminState.drawnNumbers.includes(number)) {
                alert(`O número ${number} ainda não foi sorteado!`);
                return;
            }

            card.marked[colIndex][rowIndex] = !card.marked[colIndex][rowIndex];
            savePlayerState();
            renderPlayerCards(); // Re-render to update visual
        }

        function autoMarkNumbers() {
            if (!adminState.enableAutoFill || !adminState.gameStarted || adminState.gameEnded) return;

            let changed = false;
            playerState.cards.forEach(card => {
                for (let col = 0; col < 5; col++) {
                    for (let row = 0; row < 5; row++) {
                        const number = card.numbers[col][row];
                        if (number !== 'FREE' && !card.marked[col][row] && adminState.drawnNumbers.includes(number)) {
                            card.marked[col][row] = true;
                            changed = true;
                        }
                    }
                }
            });
            if (changed) {
                savePlayerState();
                renderPlayerCards();
            }
        }

        function updatePlayerDrawnNumbersGrid() {
            const grid = document.getElementById('playerDrawnNumbersGrid');
            grid.innerHTML = '';
            adminState.drawnNumbers.forEach((num, index) => {
                const item = document.createElement('div');
                item.classList.add('drawn-number-item');
                if (index === adminState.drawnNumbers.length - 1) {
                    item.classList.add('last-drawn');
                }
                item.textContent = num;
                grid.appendChild(item);
            });
            grid.scrollTop = grid.scrollHeight; // Scroll to bottom
        }

        function checkBingo(card) {
            const marked = card.marked;

            // Check rows
            for (let r = 0; r < 5; r++) {
                if (marked[0][r] && marked[1][r] && marked[2][r] && marked[3][r] && marked[4][r]) return 'Linha';
            }

            // Check columns
            for (let c = 0; c < 5; c++) {
                if (marked[c][0] && marked[c][1] && marked[c][2] && marked[c][3] && marked[c][4]) return 'Coluna';
            }

            // Check diagonals
            if (marked[0][0] && marked[1][1] && marked[2][2] && marked[3][3] && marked[4][4]) return 'Diagonal';
            if (marked[0][4] && marked[1][3] && marked[2][2] && marked[3][1] && marked[4][0]) return 'Diagonal';

            // Check full card (if all cells are marked)
            let allMarked = true;
            for (let c = 0; c < 5; c++) {
                for (let r = 0; r < 5; r++) {
                    if (!marked[c][r]) {
                        allMarked = false;
                        break;
                    }
                }
                if (!allMarked) break;
            }
            if (allMarked) return 'Cartela Cheia';

            return null;
        }

        function callBingo() {
            if (playerState.status !== 'active' || adminState.gameEnded) {
                alert('Você não pode chamar BINGO no momento.');
                return;
            }
            if (playerState.bingoCalled) {
                alert('Você já chamou BINGO e está aguardando validação.');
                return;
            }

            let bingoFound = false;
            let bingoType = '';
            let bingoCardId = '';

            for (const card of playerState.cards) {
                const type = checkBingo(card);
                if (type) {
                    bingoFound = true;
                    bingoType = type;
                    bingoCardId = card.id;
                    break;
                }
            }

            if (bingoFound) {
                playerState.bingoCalled = true;
                playerState.bingoValidated = null; // Reset validation status
                savePlayerState();

                // Notify admin
                const adminData = localStorage.getItem(`bingo_admin_${playerState.roomCode}`);
                if (adminData) {
                    let currentAdminState = JSON.parse(adminData);
                    currentAdminState.bingoCalls.push({
                        playerId: playerState.playerId,
                        cardId: bingoCardId,
                        type: bingoType,
                        timestamp: Date.now(),
                        validated: null
                    });
                    currentAdminState.lastUpdate = Date.now();
                    localStorage.setItem(`bingo_admin_${playerState.roomCode}`, JSON.stringify(currentAdminState));
                }
                showBingoCalledModal();
            } else {
                alert('Você ainda não tem BINGO! Continue jogando.');
            }
        }

        // --- Modals ---
        function showBingoCalledModal() {
            document.getElementById('bingoCalledModal').classList.add('active');
            document.getElementById('bingoCalledModal').style.display = 'flex';
        }

        function closeBingoCalledModal() {
            document.getElementById('bingoCalledModal').classList.remove('active');
            document.getElementById('bingoCalledModal').style.display = 'none';
        }

        function showBingoValidationResultModal(title, message) {
            document.getElementById('bingoValidationTitle').textContent = title;
            document.getElementById('bingoValidationMessage').textContent = message;
            document.getElementById('bingoValidationResultModal').classList.add('active');
            document.getElementById('bingoValidationResultModal').style.display = 'flex';
        }

        function closeBingoValidationResultModal() {
            document.getElementById('bingoValidationResultModal').classList.remove('active');
            document.getElementById('bingoValidationResultModal').style.display = 'none';
        }

        // --- Inicialização ---
        document.addEventListener('DOMContentLoaded', () => {
            if (!loadPlayerState()) {
                // If no room code in URL or no existing player state, show screen 1
                showScreen('screen1');
            } else {
                // If room code exists, try to load admin state immediately
                const adminData = localStorage.getItem(`bingo_admin_${playerState.roomCode}`);
                if (adminData) {
                    adminState = JSON.parse(adminData);
                    playerState.lastAdminUpdate = adminState.lastUpdate;
                    updateUI();
                } else {
                    alert('Sala não encontrada ou encerrada. Por favor, verifique o link.');
                    showScreen('screen1');
                    playerState.roomCode = null; // Clear invalid room code
                    playerState.playerId = null;
                    sessionStorage.clear(); // Clear player session
                }
            }

            // Polling para atualizar o estado do jogo do admin
            setInterval(() => {
                if (playerState.roomCode) {
                    const adminData = localStorage.getItem(`bingo_admin_${playerState.roomCode}`);
                    if (adminData) {
                        const newAdminState = JSON.parse(adminData);
                        if (newAdminState.lastUpdate > playerState.lastAdminUpdate) {
                            adminState = newAdminState;
                            playerState.lastAdminUpdate = adminState.lastUpdate;
                            updateUI();
                        }
                        // Always update admin about player's current state
                        updateAdminPlayers();
                    } else {
                        // Admin room no longer exists
                        alert('A sala de bingo foi encerrada pelo administrador.');
                        window.location.href = 'index.html'; // Redirect to home
                    }
                } else {
                    // No room code, ensure player is on screen 1
                    showScreen('screen1');
                }
            }, 2000); // A cada 2 segundos
        });
    </script>
</body>
</html>